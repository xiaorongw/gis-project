---
title: "Data Preparation"
author: "Tiny Blocks"
date: "10/22/2020"
output:
  html_document:
    theme: spacelab 
    toc: true
    toc_depth: 5
    toc_float: true
    code_folding: show
    number_sections: true
    df_print: paged
    
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message=FALSE, warning=FALSE}
packages = c('tmap', 'SpatialAcc', 'sf', 'ggstatsplot', 'tidyverse')

for(p in packages){
  if(!require(p, character.only = T)){
    install.packages(p)
  }
  library(p, character.only = T)
}
```

# Importing Geospatial Data
```{r}
na_validity_check <-function(input){
  print("Check for CRS...")
  print(st_crs(input))
  print("Check for NA...")
  print(input[rowSums(is.na(input))!=0,])
  test <- st_is_valid(input,reason=TRUE)
  print("Check for invalid geometry...")
  length(which(test!= "Valid Geometry"))
}
```

```{r message=FALSE, warning=FALSE}
subzone = st_read(dsn = "data/geospatial/subzone.kml")
cib = st_read(dsn = "data/geospatial", layer = "cib_gardens")
comm_club = st_read(dsn = "data/geospatial/community_clubs.kml")
comm_use_site = st_read(dsn = "data/geospatial/community_use_sites.kml")
dus_sports_facilities = st_read(dsn = "data/geospatial", layer = "dus_school_sports_facilities")
nature_areas = st_read(dsn = "data/geospatial/nature_areas.kml")
np_activity_area = st_read(dsn = "data/geospatial/nparks_activity_area.kml")
np_parks = st_read(dsn = "data/geospatial/nparks_parks.kml")
np_play_fitness = st_read(dsn = "data/geospatial/nparks_play_fitness_equipment.kml")
park_loop = st_read(dsn = "data/geospatial/park_connector_loop.kml")
preschools = st_read(dsn = "data/geospatial/preschools.kml")
schools = st_read(dsn = "data/geospatial", layer = "schools")
student_care = st_read(dsn = "data/geospatial/student_care.kml")
sportsg_facilities= st_read(dsn = "data/geospatial/sportsg_sports_facilities.kml")
watersports_facilities = st_read(dsn = "data/geospatial", layer = "water_sport_facilities")
```

## Data Cleaning and Transforming Subzone Layer
```{r}
na_validity_check(subzone)
```

```{r warning=FALSE}
subzone <- st_set_crs(subzone, 3414)
subzone<- st_make_valid(subzone)
```

```{r}
getName <- function(input){
  noHtml <- str_replace_all(input,"<.*?>","")
  matched_str <- str_match(noHtml, "\\sSUBZONE_N (.*?) SUBZONE_C")[,2]
  return(str_trim(matched_str))
}

subzone <- subzone %>%
  mutate(`SUBZONE_N` = getName(subzone$Description)) 
head(subzone, 1)
```

## Data transformation for required layers

```{r warning=FALSE}
nature_areas <- st_transform(nature_areas, 3414)
nature_areas<- st_make_valid(nature_areas)
np_activity_area <- st_transform(np_activity_area, 3414)
np_parks <- st_transform(np_parks, 3414)
np_parks<- st_make_valid(np_parks)
np_play_fitness <- st_transform(np_play_fitness, 3414)
park_loop <- st_transform(park_loop, 3414)
preschools <- st_transform(preschools, 3414)
sportsg_facilities <- st_transform(sportsg_facilities, 3414)
student_care <- st_transform(student_care, 3414)
watersports_facilities <- st_set_crs(watersports_facilities, 3414)
cib <- st_set_crs(cib, 3414)
comm_club <- st_transform(comm_club, 3414)
comm_use_site <- st_transform(comm_use_site, 3414)
dus_sports_facilities <- st_set_crs(dus_sports_facilities, 3414)
```

# Import Aspatial Data

**HDB**

```{r}
hdb <- read_csv('data/aspatial/hdb_osm.csv')
```
```{r warning=FALSE}
hdb <- st_as_sf(hdb, 
                coords = c('X', 'Y'),
                crs = 3414) %>%
  st_set_crs(3414)
```


```{r}
population <- read_csv('data/aspatial/population.csv')
```

<br>

# Data preparation

<br>

* Extract population data for 2020 only
* **Calculate children population living in HDB: children aged 0 to 7**
  * Number of children aged 5 to 7 is estimated as 3/5 of the total number of children aged 5 to 9
  
$$Number\ of\ children\ aged\ 0\ to\ 7\ in\ subzone\ =\ Number\ of\ children\ aged\ 0\ to\ 4 + (\frac{3}{5}*Number\ of\ children\  aged\ 5\ to\ 9)$$

```{r}
children_population <- population %>%
  filter(Time == 2020) %>%
  group_by(PA, SZ, AG, TOD) %>%
  summarise(`POP` = sum(`Pop`)) %>%
  ungroup() %>%
  pivot_wider(names_from = AG, values_from = POP) %>%
  mutate(children_population = `0_to_4` + (3/5 * `5_to_9`)) %>%
  select(PA, SZ, TOD, children_population) %>%
  pivot_wider(names_from = TOD, values_from = children_population) %>%
  mutate_at(.vars = vars(PA, SZ), .funs = ~ toupper(.)) %>%
  mutate(children_hdb = rowSums(.[4:7])) %>%
  select(SZ, children_hdb)

children_population
```

<br>

**Join population data with subzone data**

```{r}
subzone_children <- subzone %>%
  left_join(children_population, by = c('SUBZONE_N' = 'SZ')) %>%
  select(-c(Description, Name))

glimpse(subzone_children)
```
<br>

**Calculate number of children aged 0 to 7 in each HDB block**

* Children aged 0 to 7 are the key focus of this project, as these are the [formative years of children development]().
* The number of children residing in each HDB block of a subzone will be estimated by dividing the total number of children living in the subzone, by the total number of HDB blocks in that subzone.

$$Number\ of\ children\ in\ each\ HDB\ =\ \frac{Number\ of\ children\ in\ subzone}{Number\ of\ HDB\ blocks\ in\ subzone}$$

<br>

**Count number of HDB blocks in each subzone**

```{r}
subzone_children$num_hdb <- lengths(st_intersects(subzone_children, hdb))

summary(subzone_children$num_hdb)
```

```{r}
qtm(subzone_children, 'num_hdb')
```

```{r}
qtm(subzone_children, 'children_hdb')
```


<br>

**Calculate number of children in each HDB: demand**

```{r}
subzone_children <- subzone_children %>%
  # Calculate demand. If there are no HDB
  mutate(children_each_hdb = ifelse(num_hdb != 0, children_hdb / num_hdb, 0))

summary(subzone_children$children_each_hdb)
```

```{r}
tm_shape(subzone_children) +
  tm_polygons('children_each_hdb',
              style = 'jenks')
```

<br>

**Add information on number of children for each HDB to HDB data**

```{r}
hdb <- hdb %>%
  select(`ID`, `addr_house`, `addr_postc`, `addr_stree`, `building_l`) %>%
  rename(house_number = addr_house,
         postal_code = addr_postc,
         street = addr_stree,
         num_levels = building_l) %>%
  st_join(subzone_children, join = st_intersects)

glimpse(hdb)
```

