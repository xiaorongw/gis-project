---
title: "Data Preparation"
author: "Tiny Blocks"
date: "10/22/2020"
output:
  html_document:
    theme: spacelab 
    toc: true
    toc_depth: 5
    toc_float: true
    code_folding: show
    number_sections: true
    df_print: paged
    
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message=FALSE, warning=FALSE}
packages = c('tmap', 'SpatialAcc', 'sf', 'ggstatsplot', 'tidyverse')

for(p in packages){
  if(!require(p, character.only = T)){
    install.packages(p)
  }
  library(p, character.only = T)
}
```

# Importing Geospatial Data
```{r}
na_validity_check <-function(input){
  print("Check for CRS...")
  print(st_crs(input))
  print("Check for NA...")
  print(input[rowSums(is.na(input))!=0,])
  test <- st_is_valid(input,reason=TRUE)
  print("Check for invalid geometry...")
  length(which(test!= "Valid Geometry"))
}
```

```{r message=FALSE, warning=FALSE}
subzone = st_read(dsn = "data/geospatial/subzone.kml")
cib = st_read(dsn = "data/geospatial", layer = "cib_gardens")
comm_club = st_read(dsn = "data/geospatial/community_clubs.kml")
comm_use_site = st_read(dsn = "data/geospatial/community_use_sites.kml")
dus_sports_facilities = st_read(dsn = "data/geospatial", layer = "dus_school_sports_facilities")
nature_areas = st_read(dsn = "data/geospatial/nature_areas.kml")
np_activity_area = st_read(dsn = "data/geospatial/nparks_activity_area.kml")
np_parks = st_read(dsn = "data/geospatial/nparks_parks.kml")
np_play_fitness = st_read(dsn = "data/geospatial/nparks_play_fitness_equipment.kml")
park_loop = st_read(dsn = "data/geospatial/park_connector_loop.kml")
preschools = st_read(dsn = "data/geospatial/preschools.kml")
schools = st_read(dsn = "data/geospatial", layer = "schools")
student_care = st_read(dsn = "data/geospatial/student_care.kml")
sportsg_facilities= st_read(dsn = "data/geospatial/sportsg_sports_facilities.kml")
watersports_facilities = st_read(dsn = "data/geospatial", layer = "water_sport_facilities")
```

## Data Cleaning and Transfoming Subzone Layer
```{r}
na_validity_check(subzone)
```

```{r warning=FALSE}
subzone <- st_set_crs(subzone, 3414)
subzone<- st_make_valid(subzone)
```

```{r}
getName <- function(input){
  noHtml <- str_replace_all(input,"<.*?>","")
  matched_str <- str_match(noHtml, "\\sSUBZONE_N (.*?) SUBZONE_C")[,2]
  return(str_trim(matched_str))
}

subzone <- subzone %>%
  mutate(`SUBZONE_N` = getName(subzone$Description)) 
head(subzone, 1)
```

## Data transformation for required layers

```{r warning=FALSE}
nature_areas <- st_transform(nature_areas, 3414)
nature_areas<- st_make_valid(nature_areas)
np_activity_area <- st_transform(np_activity_area, 3414)
np_parks <- st_transform(np_parks, 3414)
np_parks<- st_make_valid(np_parks)
np_play_fitness <- st_transform(np_play_fitness, 3414)
park_loop <- st_transform(park_loop, 3414)
preschools <- st_transform(preschools, 3414)
sportsg_facilities <- st_transform(sportsg_facilities, 3414)
student_care <- st_transform(student_care, 3414)
watersports_facilities <- st_set_crs(watersports_facilities, 3414)
cib <- st_set_crs(cib, 3414)
comm_club <- st_transform(comm_club, 3414)
comm_use_site <- st_transform(comm_use_site, 3414)
dus_sports_facilities <- st_set_crs(dus_sports_facilities, 3414)

```

# Import Aspatial Data
```{r}
hdb <- read_csv('data/aspatial/hdb.csv')
hdb <- hdb %>%
  st_as_sf(coords = c('longtitude', 'latitude'),
           crs = 3414)
```

```{r}
st_crs(hdb)
```

```{r}
population <- read_csv('data/aspatial/population.csv')
```

<br>

# Join population data with subzone data

* Extract population data for 2020 only
* Calculate total population
* Calculate children population: children aged 0 to 7
  * Number of children aged 5 to 7 is estimated as 3/5 of the total number of children aged 5 to 9


```{r}
population_20 <- population %>%
  filter(Time == 2020) %>%
  spread(AG, Pop) %>%
  mutate(total_population = rowSums(.[5:22])) %>%  
  mutate(children_population = `0_to_4` + (3/5 * `5_to_9`)) %>%
  rename(dwelling_type = TOD) %>%
  mutate_at(.vars = vars(PA, SZ), .funs = funs(toupper))

length(unique(population_20$SZ))
```




