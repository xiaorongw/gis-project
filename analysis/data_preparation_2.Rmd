---
title: "Data Preparation"
author: "Tiny Blocks"
date: "10/22/2020"
output:
  html_document:
    theme: spacelab 
    toc: true
    toc_depth: 5
    toc_float: true
    code_folding: show
    number_sections: true
    df_print: paged
    
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message=FALSE, warning=FALSE}
packages = c('tmap', 'SpatialAcc', 'sf', 'ggstatsplot', 'tidyverse')

for(p in packages){
  if(!require(p, character.only = T)){
    install.packages(p)
  }
  library(p, character.only = T)
}
```


# Importing Geospatial Data
```{r}
na_validity_check <-function(input){
  print("Check for CRS...")
  print(st_crs(input))
  print("Check for NA...")
  print(input[rowSums(is.na(input))!=0,])
  test <- st_is_valid(input,reason=TRUE)
  print("Check for invalid geometry...")
  length(which(test!= "Valid Geometry"))
}
```

```{r message=FALSE, warning=FALSE}
subzone = st_read(dsn = "data/geospatial/subzone.kml")
towns = st_read(dsn = "data/geospatial", layer = "hdb_towns")
planning_area <- st_read(dsn = 'data/geospatial', layer = 'plan_area')
```

## Data Cleaning and Transforming Subzone Layer
```{r}
na_validity_check(subzone)
```

```{r warning=FALSE}
subzone <- st_transform(subzone, 3414)
subzone<- st_make_valid(subzone)
```

```{r}
getName <- function(input){
  noHtml <- str_replace_all(input,"<.*?>","")
  matched_str <- str_match(noHtml, "\\sSUBZONE_N (.*?) SUBZONE_C")[,2]
  return(str_trim(matched_str))
}

subzone <- subzone %>%
  mutate(`SUBZONE_N` = getName(subzone$Description)) 
head(subzone, 1)
```

```{r warning=FALSE}
towns <- st_transform(towns, 3414)
```

<br>

# Import Aspatial Data

<br>

**HDB**

```{r}
hdb <- read_csv('data/aspatial/hdb_osm.csv')
```

```{r warning=FALSE}
hdb <- st_as_sf(hdb, 
                coords = c('X', 'Y'),
                crs = 4326) %>%
  st_transform(3414)
```


```{r}
population <- read_csv('data/aspatial/population.csv')
```

<br>

# Data preparation

<br>

* Extract population data for 2020 only
* **Calculate children population living in HDB: children aged 0 to 7**
  * Number of children aged 5 to 7 is estimated as 3/5 of the total number of children aged 5 to 9
  
$$Number\ of\ children\ aged\ 0\ to\ 7\ in\ subzone\ =\ Number\ of\ children\ aged\ 0\ to\ 4 + (\frac{3}{5}*Number\ of\ children\  aged\ 5\ to\ 9)$$

```{r}
children_population <- population %>%
  filter(Time == 2020) %>%
  group_by(PA, SZ, AG, TOD) %>%
  summarise(`POP` = sum(`Pop`)) %>%
  ungroup() %>%
  pivot_wider(names_from = AG, values_from = POP) %>%
  mutate(children_population = `0_to_4` + (3/5 * `5_to_9`)) %>%
  select(PA, SZ, TOD, children_population) %>%
  pivot_wider(names_from = TOD, values_from = children_population) %>%
  mutate_at(.vars = vars(PA, SZ), .funs = ~ toupper(.)) %>%
  mutate(children_hdb = rowSums(.[4:7])) %>%
  select(SZ, children_hdb)

children_population
```

<br>

**Join population data with subzone data**

```{r}
subzone_children <- subzone %>%
  left_join(children_population, by = c('SUBZONE_N' = 'SZ')) %>%
  select(-c(Description, Name))

glimpse(subzone_children)
```
<br>

**Calculate number of children aged 0 to 7 in each HDB block**

* Children aged 0 to 7 are the key focus of this project, as these are the [formative years of children development]().
* The number of children residing in each HDB block of a subzone will be estimated by dividing the total number of children living in the subzone, by the total number of HDB blocks in that subzone.

$$Number\ of\ children\ in\ each\ HDB\ =\ \frac{Number\ of\ children\ in\ subzone}{Number\ of\ HDB\ blocks\ in\ subzone}$$

<br>

**Count number of HDB blocks in each subzone**

```{r}
subzone_children$num_hdb <- lengths(st_intersects(subzone_children, hdb))

summary(subzone_children$num_hdb)
```

```{r}
qtm(subzone_children, 'num_hdb')
```

```{r}
qtm(subzone_children, 'children_hdb')
```


<br>

**Calculate number of children in each HDB: demand**

```{r}
subzone_children <- subzone_children %>%
  # Calculate demand. If there are no HDB
  mutate(children_each_hdb = round(ifelse(num_hdb != 0, children_hdb / num_hdb, 0), 0))

summary(subzone_children$children_each_hdb)
```

```{r}
tm_shape(subzone_children) +
  tm_polygons('children_each_hdb',
              style = 'jenks')
```

<br>

**Add information on number of children for each HDB to HDB data**

```{r}
hdb <- hdb %>%
  select(`ID`, `addr_house`, `addr_postc`, `addr_stree`, `building_l`) %>%
  rename(house_number = addr_house,
         postal_code = addr_postc,
         street = addr_stree,
         num_levels = building_l) %>%
  st_join(subzone_children, join = st_intersects)

glimpse(hdb)
```

<br>

```{r}
# st_write(hdb, '../shinyapp/data/geospatial/hdb_processed.shp', driver = 'ESRI Shapefile')
```


```{r}
# tmap_mode('plot')
# tm_shape(subset(towns, Town == 'SENGKANG')) +
#   tm_polygons() +
#   tm_shape(hdb)+
#   tm_dots()
```


```{r warning=FALSE}
hdb_clipped <- st_intersection(hdb, subset(towns, Town == 'PUNGGOL'))
hdb_clipped
```


# Calculate accessibility

<br>

## Student care

```{r}
student_care <- st_read(dsn = 'data/geospatial/distance_matrix_', layer = 'student_care') %>%
  select(ID, Name, ADDRESSSTR, ADDRESSPOS) %>%
  rename(name = Name,
         address = ADDRESSSTR,
         postal_code = ADDRESSPOS)

glimpse(student_care)
```

```{r}
dm_student_care <- read_csv('data/aspatial/distance matrix/hdb_studentcare.csv')
```
```{r}
glimpse(dm_student_care)
```
```{r}
# subset(dm_student_care, origin_id %in% hdb_clipped$ID)
```


**Tidy matrix -- make wider**
```{r}
dm_student_care <- dm_student_care %>%
  # Obtain final matrix
  select(origin_id, destination_id, total_cost) %>%
  pivot_wider(names_from = destination_id, values_from = total_cost) %>%
  select(-origin_id)
  
# Convert to km
dm_student_care <- as.matrix(dm_student_care/1000)
# dm_student_care
```

<br>

**Calculate average student care capacity for each student care centre**

* Total capacity of all student care centres in Singapore is [42,907 in 2019](https://www.msf.gov.sg/research-and-data/Research-and-Statistics/Pages/Family-Services-Statistics-on-Student-Care-Centres.aspx).
* Total number of student care centres in Singapore is 425.

$$Average\ student\ care\ capacity\ for\ each\ centre\ = \frac{Total\ capacity\ of\ student\ care\ in\ Singapore}{Number\ of\ student\ care\ centres\ in\ Singapore}$$
```{r}
student_care_capacity <- round(42907 / nrow(student_care), 0)
student_care_capacity
```

<br>

* Average student care capacity for each centre is estimated to be 101.

<br>

**Calculate Hansen accessibility**
```{r}
student_care_capacity_list <- rep(student_care_capacity, nrow(student_care))

acc_Hansen <- data.frame(ac(hdb$children_each_hdb,
                  student_care_capacity_list,
                  dm_student_care, 
                  d0 = 50,
                  power = 1.5, 
                  family = "SAM"))

colnames(acc_Hansen) <- "accHansen"
acc_Hansen <- as_tibble(acc_Hansen)
hansen_student_care <- bind_cols(hdb, acc_Hansen)
```

```{r}
hansen_student_care
```

<br>

## School

**Import schools**

```{r}
pri_schools <- st_read(dsn = 'data/geospatial/distance_matrix_', layer = 'schools_primary') %>%
  select(ID, school_nam, address, postal_cod) %>%
  rename(name = school_nam,
         postal_code = postal_cod)

glimpse(pri_schools)
```

<br>

**Import distance matrix**
```{r}
dm_pri_schools <- read_csv('data/aspatial/distance matrix/hdb_school.csv')
```

```{r}
glimpse(dm_pri_schools)
```

**Tidy matrix -- make wider**
```{r}
dm_pri_schools <- dm_pri_schools %>%
  # Obtain final matrix
  select(origin_id, destination_id, total_cost) %>%
  pivot_wider(names_from = destination_id, values_from = total_cost) %>%
  select(-origin_id)
  
# Convert to km
dm_pri_schools <- as.matrix(dm_pri_schools/1000)
```

<br>

**Calculate average primary school capacity for each school**

* Enrolment for primary 1 will be utilised to calculate primary school capacity.
* Total number of primary schools in Singapore is 170.
* Primary 1 enrolment for 2019 is [37,671](https://www.moe.gov.sg/docs/default-source/document/publications/education-statistics-digest/esd_2019.pdf)

```{r}
school_capacity <- round(37671 / nrow(pri_schools))
school_capacity
```

<br>

**Calculate Hansen accessibility**
```{r}
school_capacity_list <- rep(school_capacity, nrow(pri_schools))

acc_Hansen <- data.frame(ac(hdb$children_each_hdb,
                  school_capacity_list,
                  dm_pri_schools, 
                  d0 = 50,
                  power = 2, 
                  family = "Hansen"))

colnames(acc_Hansen) <- "accHansen"
acc_Hansen <- as_tibble(acc_Hansen)
hansen_pri_schools <- bind_cols(hdb, acc_Hansen)
```

```{r}
hansen_pri_schools
```

<br>

## Water sports facilities

<br>

**Import water sports facilities**

```{r}
watersports_facilities <- st_read(dsn = 'data/geospatial/distance_matrix_', layer = 'water_sport_facilities') %>%
  select(ID, NAME, ADDRESSSTR, ADDRESSPOS) %>%
  rename(name = NAME,
         address = ADDRESSSTR,
         postal_code = ADDRESSPOS)

glimpse(watersports_facilities)
```

<br>

**Import distance matrix**
```{r}
dm_watersports_facilities <- read_csv('data/aspatial/distance matrix/hdb_watersports.csv')
```

```{r}
glimpse(dm_watersports_facilities)
```

**Tidy matrix -- make wider**
```{r}
dm_watersports_facilities <- dm_watersports_facilities %>%
  # Obtain final matrix
  select(origin_id, destination_id, total_cost) %>%
  pivot_wider(names_from = destination_id, values_from = total_cost) %>%
  select(-origin_id)
  
# Convert to km
dm_watersports_facilities <- as.matrix(dm_watersports_facilities/1000)
```

<br>

**Calculate Hansen accessibility**
```{r}
watersports_capacity_list <- rep(1, nrow(watersports_facilities))

acc_Hansen <- data.frame(ac(hdb$children_each_hdb,
                  watersports_capacity_list,
                  dm_watersports_facilities, 
                  d0 = 50,
                  power = 1.5, 
                  family = "Hansen"))

colnames(acc_Hansen) <- "accHansen"
acc_Hansen <- as_tibble(acc_Hansen)
hansen_watersports_facilities <- bind_cols(hdb, acc_Hansen)
```

```{r}
hansen_watersports_facilities
```

<br>

# Dual-use scheme school sports facilities

<br>

**Import DUS sports facilities**

```{r}
dus_sports_facilities <- st_read(dsn = 'data/geospatial/distance_matrix_', layer = 'dus_school_sports_facilities') %>%
  select(ID, SCHOOL_NAM, ADDRESS, POSTAL_COD, FACILITIES) %>%
  rename(name = SCHOOL_NAM,
         address = ADDRESS,
         postal_code = POSTAL_COD,
         facilities = FACILITIES)

glimpse(dus_sports_facilities)
```

<br>

**Import distance matrix**
```{r}
dm_dus_school_sports_facilities <- read_csv('data/aspatial/distance matrix/hdb_dus.csv')
```

```{r}
glimpse(dm_dus_school_sports_facilities)
```

**Tidy matrix -- make wider**
```{r}
dm_dus_school_sports_facilities <- dm_dus_school_sports_facilities %>%
  # Obtain final matrix
  select(origin_id, destination_id, total_cost) %>%
  pivot_wider(names_from = destination_id, values_from = total_cost) %>%
  select(-origin_id)
  
# Convert to km
dm_dus_school_sports_facilities <- as.matrix(dm_dus_school_sports_facilities/1000)
```

<br>

**Calculate Hansen accessibility**
```{r}
dus_capacity_list <- rep(1, nrow(dus_sports_facilities))

acc_Hansen <- data.frame(ac(hdb$children_each_hdb,
                  dus_capacity_list,
                  dm_dus_school_sports_facilities, 
                  d0 = 50,
                  power = 2, 
                  family = "Hansen"))

colnames(acc_Hansen) <- "accHansen"
acc_Hansen <- as_tibble(acc_Hansen)
hansen_dus_school_sports_facilities <- bind_cols(hdb, acc_Hansen)
```

```{r}
hansen_dus_school_sports_facilities
```

<br>

# Community in bloom gardens

<br>

**Import community in bloom gardens**

```{r}
cib_gardens <- st_read(dsn = 'data/geospatial/distance_matrix_', layer = 'cib_gardens') %>%
  select(ID, ADDRESS, DIVISION, CONSTITUEN, CATEGORY) %>%
  rename(address = ADDRESS,
         division = DIVISION, 
         constituency = CONSTITUEN,
         category = CATEGORY)
  
glimpse(cib_gardens)
```

<br>

**Import distance matrix**
```{r}
dm_cib_gardens <- read_csv('data/aspatial/distance matrix/hdb_cib.csv')
```

```{r}
glimpse(dm_cib_gardens)
```

**Tidy matrix -- make wider**
```{r}
dm_cib_gardens <- dm_cib_gardens %>%
  # Obtain final matrix
  select(origin_id, destination_id, total_cost) %>%
  pivot_wider(names_from = destination_id, values_from = total_cost) %>%
  select(-origin_id)
  
# Convert to km
dm_cib_gardens <- as.matrix(dm_cib_gardens/1000)
```

<br>

**Calculate Hansen accessibility**
```{r}
cib_capacity_list <- rep(1, nrow(cib_gardens))

acc_Hansen <- data.frame(ac(hdb$children_each_hdb,
                  cib_capacity_list,
                  dm_cib_gardens, 
                  d0 = 50,
                  power = 2.5, 
                  family = "Hansen"))

colnames(acc_Hansen) <- "accHansen"
acc_Hansen <- as_tibble(acc_Hansen)
hansen_cib_gardens <- bind_cols(hdb, acc_Hansen)
```

```{r}
hansen_cib_gardens
```

<br>

# Pre-schools

<br>

**Import pre-schools**

```{r}
preschools <- st_read(dsn = 'data/geospatial/distance_matrix_', layer = 'preschools') %>%
  select(ID, CENTRE_NAM, ADDRESS, POSTAL_COD) %>%
  rename(name = CENTRE_NAM,
         address = ADDRESS,
         postal_code = POSTAL_COD)

  
glimpse(preschools)
```

<br>

**Import distance matrix**
```{r}
dm_preschools <- read_csv('data/aspatial/distance matrix/hdb_preschools.csv')
```

```{r}
glimpse(dm_preschools)
```

**Tidy matrix -- make wider**
```{r}
dm_preschools <- dm_preschools %>%
  # Obtain final matrix
  select(origin_id, destination_id, total_cost) %>%
  pivot_wider(names_from = destination_id, values_from = total_cost) %>%
  select(-origin_id)
  
# Convert to km
dm_preschools <- as.matrix(dm_preschools/1000)
```

<br>

**Calculate average pre-school capacity**

* Pre-schools include childcare centres and kindergartens.
* Average capacity for a pre-school is estimated using the total capacity of pre-schools in Singapore, divided by the total number of pre-schools in Singapore.
* Form the data, the total number of pre-schools in Singapore is 1925.
* Total capacity of pre-schools (childcare and kindergartens) is [215,579](https://www.ecda.gov.sg/Operators/Pages/Statistics-n-Reports.aspx)

```{r}
preschool_capacity <- round(215579 / nrow(preschools))
preschool_capacity
```

<br>

**Calculate Hansen accessibility**
```{r}
preschool_capacity_list <- rep(preschool_capacity, nrow(preschools))

acc_Hansen <- data.frame(ac(hdb$children_each_hdb,
                  preschool_capacity_list,
                  dm_preschools, 
                  d0 = 50,
                  power = 2, 
                  family = "Hansen"))

colnames(acc_Hansen) <- "accHansen"
acc_Hansen <- as_tibble(acc_Hansen)
hansen_preschools <- bind_cols(hdb, acc_Hansen)
```



```{r}
hansen_preschools
```

<br>

```{r}
hansen_preschools[is.na(hansen_preschools)] <- 0
```


```{r}
glimpse(hansen_preschools)
```

<br>

# Sportsg sports facilities

<br>

**Import sportsg facilities**

```{r}
sportsg_facilities <- st_read(dsn = 'data/geospatial/distance_matrix_', layer = 'sportsg_sports_facilities') %>%
  select(ROAD_NAME, FACILITIES) %>%
  rename(address = ROAD_NAME,
         facilities = FACILITIES)

glimpse(sportsg_facilities)
```

<br>

**Import distance matrix**
```{r}
dm_sportsg_facilities <- read_csv('data/aspatial/distance matrix/hdb_sportsg.csv')
```

```{r}
glimpse(dm_sportsg_facilities)
```

**Tidy matrix -- make wider**
```{r}
dm_sportsg_facilities <- dm_sportsg_facilities %>%
  # Obtain final matrix
  select(origin_id, destination_id, total_cost) %>%
  pivot_wider(names_from = destination_id, values_from = total_cost) %>%
  select(-origin_id)
  
# Convert to km
dm_sportsg_facilities <- as.matrix(dm_sportsg_facilities/1000)
```

<br>

**Calculate Hansen accessibility**
```{r}
sportsg_capacity_list <- rep(1, nrow(sportsg_facilities))

acc_Hansen <- data.frame(ac(hdb$children_each_hdb,
                  sportsg_capacity_list,
                  dm_sportsg_facilities, 
                  d0 = 50,
                  power = 1.5, 
                  family = "Hansen"))

colnames(acc_Hansen) <- "accHansen"
acc_Hansen <- as_tibble(acc_Hansen)
hansen_sportsg_facilities <- bind_cols(hdb, acc_Hansen)
```

```{r}
hansen_sportsg_facilities
```

<br>

```{r}
glimpse(hansen_sportsg_facilities)
```

<br>

# Play and fitness equipment

<br>

**Import play and fitness equipment**

```{r}
play_fitness <- st_read(dsn = 'data/geospatial/distance_matrix_', layer = 'nparks_play_fitness_equipment') %>%
  select(geometry)

glimpse(play_fitness)
```

<br>

**Import distance matrix**
```{r}
dm_play_fitness <- read_csv('data/aspatial/distance matrix/hdb_play_fitness.csv')
```

```{r}
glimpse(dm_play_fitness)
```

**Tidy matrix -- make wider**
```{r}
dm_play_fitness <- dm_play_fitness %>%
  # Obtain final matrix
  select(origin_id, destination_id, total_cost) %>%
  pivot_wider(names_from = destination_id, values_from = total_cost) %>%
  select(-origin_id)
  
# Convert to km
dm_play_fitness <- as.matrix(dm_play_fitness/1000)
```

<br>

**Calculate Hansen accessibility**
```{r}
play_fitness_capacity_list <- rep(1, nrow(play_fitness))

acc_Hansen <- data.frame(ac(hdb$children_each_hdb,
                  play_fitness_capacity_list,
                  dm_play_fitness, 
                  d0 = 50,
                  power = 2, 
                  family = "Hansen"))

colnames(acc_Hansen) <- "accHansen"
acc_Hansen <- as_tibble(acc_Hansen)
hansen_play_fitness <- bind_cols(hdb, acc_Hansen)
```

```{r}
hansen_play_fitness
```

<br>

# Parks

<br>

**Import parks**

```{r}
parks <- st_read(dsn = 'data/geospatial/distance_matrix_', layer = 'nparks_parks')  %>%
  select(Name) %>%
  rename(name = Name)

glimpse(parks)
```

<br>

**Import distance matrix**
```{r}
dm_parks <- read_csv('data/aspatial/distance matrix/hdb_nparks.csv')
```

```{r}
glimpse(dm_parks)
```

**Tidy matrix -- make wider**
```{r}
dm_parks <- dm_parks %>%
  # Obtain final matrix
  select(origin_id, destination_id, total_cost) %>%
  pivot_wider(names_from = destination_id, values_from = total_cost) %>%
  select(-origin_id)
  
# Convert to km
dm_parks <- as.matrix(dm_parks/1000)
```

<br>

**Calculate Hansen accessibility**
```{r}
parks_capacity_list <- rep(1, nrow(parks))

acc_Hansen <- data.frame(ac(hdb$children_each_hdb,
                  parks_capacity_list,
                  dm_parks, 
                  d0 = 50,
                  power = 1, 
                  family = "Hansen"))

colnames(acc_Hansen) <- "accHansen"
acc_Hansen <- as_tibble(acc_Hansen)
hansen_parks <- bind_cols(hdb, acc_Hansen)
```

```{r}
hansen_parks
```

<br>

# Community use sites

<br>

**Import community use sites**

```{r}
community_use_sites <- st_read(dsn = 'data/geospatial/distance_matrix_', layer = 'community_use_sites') %>%
  select(Name) %>%
  rename(name = Name)

glimpse(community_use_sites)
```

<br>

**Import distance matrix**
```{r}
dm_community_use_sites <- read_csv('data/aspatial/distance matrix/hdb_community_use_sites.csv')
```

```{r}
glimpse(dm_community_use_sites)
```

**Tidy matrix -- make wider**
```{r}
dm_community_use_sites <- dm_community_use_sites %>%
  # Obtain final matrix
  select(origin_id, destination_id, total_cost) %>%
  pivot_wider(names_from = destination_id, values_from = total_cost) %>%
  select(-origin_id)
  
# Convert to km
dm_community_use_sites <- as.matrix(dm_community_use_sites/1000)
```

<br>

**Calculate Hansen accessibility**
```{r}
community_use_sites_capacity_list <- rep(1, nrow(community_use_sites))

acc_Hansen <- data.frame(ac(hdb$children_each_hdb,
                  community_use_sites_capacity_list,
                  dm_community_use_sites, 
                  d0 = 50,
                  power = 2, 
                  family = "Hansen"))

colnames(acc_Hansen) <- "accHansen"
acc_Hansen <- as_tibble(acc_Hansen)
hansen_community_use_sites <- bind_cols(hdb, acc_Hansen)
```

```{r}
hansen_community_use_sites
```

<br>

# Activity areas

<br>

**Import activity areas**

```{r}
activity_area <- st_read(dsn = 'data/geospatial/distance_matrix_', layer = 'nparks_activity_area') %>%
  select(geometry)

glimpse(activity_area)
```

<br>

**Import distance matrix**
```{r}
dm_activity_area <- read_csv('data/aspatial/distance matrix/hdb_activity_areas.csv')
```

```{r}
glimpse(dm_activity_area)
```

**Tidy matrix -- make wider**
```{r}
dm_activity_area <- dm_activity_area %>%
  # Obtain final matrix
  select(origin_id, destination_id, total_cost) %>%
  pivot_wider(names_from = destination_id, values_from = total_cost) %>%
  select(-origin_id)
  
# Convert to km
dm_activity_area <- as.matrix(dm_activity_area/1000)
```

<br>

**Calculate Hansen accessibility**
```{r}
activity_area_capacity_list <- rep(1, nrow(activity_area))

acc_Hansen <- data.frame(ac(hdb$children_each_hdb,
                  activity_area_capacity_list,
                  dm_activity_area, 
                  d0 = 50,
                  power = 2, 
                  family = "Hansen"))

colnames(acc_Hansen) <- "accHansen"
acc_Hansen <- as_tibble(acc_Hansen)
hansen_activity_area <- bind_cols(hdb, acc_Hansen)
```

```{r}
hansen_activity_area
```

<br>

# Nature areas

<br>

**Import nature areas**

```{r}
nature_area <- st_read(dsn = 'data/geospatial/distance_matrix_', layer = 'nature_areas') %>%
  select(geometry)

glimpse(nature_area)
```

<br>

**Import distance matrix**
```{r}
dm_nature_area <- read_csv('data/aspatial/distance matrix/hdb_nature_areas.csv')
```

```{r}
glimpse(dm_nature_area)
```

**Tidy matrix -- make wider**
```{r}
dm_nature_area <- dm_nature_area %>%
  # Obtain final matrix
  select(origin_id, destination_id, total_cost) %>%
  pivot_wider(names_from = destination_id, values_from = total_cost) %>%
  select(-origin_id)
  
# Convert to km
dm_nature_area <- as.matrix(dm_nature_area/1000)
```

<br>

**Calculate Hansen accessibility**
```{r}
nature_area_capacity_list <- rep(1, nrow(nature_area))

acc_Hansen <- data.frame(ac(hdb$children_each_hdb,
                  nature_area_capacity_list,
                  dm_nature_area, 
                  d0 = 50,
                  power = 1.5, 
                  family = "Hansen"))

colnames(acc_Hansen) <- "accHansen"
acc_Hansen <- as_tibble(acc_Hansen)
hansen_nature_area <- bind_cols(hdb, acc_Hansen)
```

```{r}
hansen_nature_area
```

<br>

# Community clubs

<br>

**Import community clubs**

```{r}
community_clubs <- st_read(dsn = 'data/geospatial/distance_matrix_', layer = 'community_clubs') %>%
  select(Name, descriptio, ADDRESSSTR, ADDRESSPOS) %>%
  rename(name = Name,
         type = descriptio,
         address = ADDRESSSTR,
         postal_code = ADDRESSPOS)

glimpse(community_clubs)
```

<br>

**Import distance matrix**
```{r}
dm_community_clubs <- read_csv('data/aspatial/distance matrix/hdb_community_clubs.csv')
```

```{r}
glimpse(dm_community_clubs)
```

**Tidy matrix -- make wider**
```{r}
dm_community_clubs <- dm_community_clubs %>%
  # Obtain final matrix
  select(origin_id, destination_id, total_cost) %>%
  pivot_wider(names_from = destination_id, values_from = total_cost) %>%
  select(-origin_id)
  
# Convert to km
dm_community_clubs <- as.matrix(dm_community_clubs/1000)
```

<br>

**Calculate Hansen accessibility**
```{r}
community_clubs_capacity_list <- rep(1, nrow(community_clubs))

acc_Hansen <- data.frame(ac(hdb$children_each_hdb,
                  community_clubs_capacity_list,
                  dm_community_clubs, 
                  d0 = 50,
                  power = 2, 
                  family = "Hansen"))

colnames(acc_Hansen) <- "accHansen"
acc_Hansen <- as_tibble(acc_Hansen)
hansen_community_clubs <- bind_cols(hdb, acc_Hansen)
```

```{r}
hansen_community_clubs
```

<br>

```{r}
library('StatMeasures')
```

```{r}
median(hansen_community_clubs$accHansen)
```


```{r}
decile <- quantile(hansen_community_clubs$accHansen, prob = seq(0, 1, length = 11), type=5)
decile

decile10 <- decile[[2]]
decile20 <- decile[[3]]
decile30 <- decile[[4]]
decile40 <- decile[[5]]
decile50 <- decile[[6]]
decile60 <- decile[[7]]
decile70 <- decile[[8]]
decile80 <- decile[[9]]
decile90 <- decile[[10]]

decile10
decile90
```

```{r}
compute_enabling_score <- function(df, name) {
  decile <- quantile(df$accHansen, prob = seq(0, 1, length = 11), type=5)

  decile10 <- decile[[2]]
  decile20 <- decile[[3]]
  decile30 <- decile[[4]]
  decile40 <- decile[[5]]
  decile50 <- decile[[6]]
  decile60 <- decile[[7]]
  decile70 <- decile[[8]]
  decile80 <- decile[[9]]
  decile90 <- decile[[10]]
  
  df1 <- df %>%
    mutate('score' = case_when(
      accHansen < decile10 ~ 1,
      (accHansen >= decile10) & (accHansen < decile20) ~ 2,
      (accHansen >= decile20) & (accHansen < decile30) ~ 3,
      (accHansen >= decile30) & (accHansen < decile40) ~ 4,
      (accHansen >= decile40) & (accHansen < decile50) ~ 5,
      (accHansen >= decile50) & (accHansen < decile60) ~ 6,
      (accHansen >= decile60) & (accHansen < decile70) ~ 7,
      (accHansen >= decile70) & (accHansen < decile80) ~ 8,
      (accHansen >= decile80) & (accHansen < decile90) ~ 9,
      (accHansen >= decile90) ~ 10))
  
  return(df1)
}
```


```{r}
summary(compute_enabling_score(hansen_activity_area)$score)
```

**Function to compute risk weights**

```{r}
# compute_risk_weights <- function(df, name) {
#   first_quantile_hansen <- quantile(df$accHansen, 0.25)[[1]]
#   median_hansen <- median(df$accHansen)
#   third_quantile_hansen <- quantile(df$accHansen, 0.75)[[1]]
#   max_hansen <- max(df$accHansen)
# 
#   df1 <- df %>%
#     mutate('risk_{name}' := case_when(
#       accHansen < first_quantile_hansen ~ 4,
#       (accHansen >= first_quantile_hansen) & (accHansen < median_hansen) ~ 3,
#       (accHansen >= median_hansen) & (accHansen < third_quantile_hansen) ~ 2,
#       (accHansen >= third_quantile_hansen) ~ 1))
#   
#   return(df1)
# }
```

<br>

**Compute risk weights**

```{r}
hansen_cib_gardens <- compute_risk_weights(hansen_cib_gardens, 'cib_gardens')
hansen_dus_school_sports_facilities <- compute_risk_weights(hansen_dus_school_sports_facilities, 'dus_sports')
hansen_preschools <- compute_risk_weights(hansen_preschools, 'preschools')
hansen_pri_schools <- compute_risk_weights(hansen_pri_schools, 'pri_schools')
hansen_student_care <- compute_risk_weights(hansen_student_care, 'student_care')
hansen_watersports_facilities <- compute_risk_weights(hansen_watersports_facilities, 'watersports_facilities')
```

<br>

```{r}
hdb_risk <- hdb %>%
  cbind(hansen_cib_gardens$risk_cib_gardens,
        hansen_dus_school_sports_facilities$risk_dus_sports,
        hansen_preschools$risk_preschools,
        hansen_pri_schools$risk_pri_schools,
        hansen_student_care$risk_student_care,
        hansen_watersports_facilities$risk_watersports_facilities) %>%
  rename(risk_cib_gardens = hansen_cib_gardens.risk_cib_gardens,
         risk_dus_sports = hansen_dus_school_sports_facilities.risk_dus_sports,
         risk_preschools = hansen_preschools.risk_preschools,
         risk_pri_schools = hansen_pri_schools.risk_pri_schools,
         risk_student_care = hansen_student_care.risk_student_care,
         risk_watersports_facilities = hansen_watersports_facilities.risk_watersports_facilities) %>%
  mutate(physical_health_risk = (risk_dus_sports + risk_watersports_facilities) / 2) %>%
  mutate(social_competence_risk = (risk_dus_sports + risk_preschools + risk_pri_schools + risk_student_care + risk_watersports_facilities) / 5) %>%
  mutate(emotional_maturity_risk = risk_cib_gardens) %>%
  mutate(composite_risk = (physical_health_risk + social_competence_risk + emotional_maturity_risk) / 3)

glimpse(hdb_risk)
```

<br>

# Visualise risk score
```{r}
tm_shape(subzone_children) +
  tm_polygons(col = 'gray90') +
  tm_shape(hdb_risk) +
  tm_bubbles(col = 'composite_risk', 
             size = 0.1,
             alpha = 0.5,
             border.lwd = NA)
```

<br>

# Save data files to shiny app

```{r}
# st_write(hdb_risk, '../shinyapp/data/geospatial/hdb_risk.shp', driver = 'ESRI Shapefile')
```

```{r}
# st_write(subzone_children, '../shinyapp/data/geospatial/subzone_children.shp', driver = 'ESRI Shapefile')
```


```{r}
tmap_mode('view')

tm_shape(hdb_risk) +
  tm_bubbles()
```

```{r}
tmap_mode('plot')
```

```{r}
hdb_accessibility <- hdb %>%
  cbind(hansen_cib_gardens$accHansen,
        hansen_dus_school_sports_facilities$accHansen,
        hansen_preschools$accHansen,
        hansen_pri_schools$accHansen,
        hansen_student_care$accHansen,
        hansen_watersports_facilities$accHansen) %>%
  rename(hansen_cib_gardens = hansen_cib_gardens.accHansen,
         hansen_dus_sports = hansen_dus_school_sports_facilities.accHansen,
         hansen_preschools = hansen_preschools.accHansen,
         hansen_pri_schools = hansen_pri_schools.accHansen,
         hansen_student_care = hansen_student_care.accHansen,
         hansen_watersports_facilities = hansen_watersports_facilities.accHansen)
hdb_accessibility
```

<br>

# Export accessibility data file

```{r}
# st_write(hdb_accessibility, '../shinyapp/data/geospatial/hdb_accessibility.shp', driver = 'ESRI Shapefile')
```


```{r}
tmap_mode('view')

tm_shape(hdb_accessibility) +
  tm_bubbles(col = 'hansen_student_care')
```

